@page "/"
@using Core.Model
@using ServerAPI.Repositories
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage 

<h1 class="mb-3">Tilgængelige Annoncer</h1>

<div class="ads-container">
    @if (activeAds == null)
    {
            <p class="loading"><em>Loading...</em></p>
    }
    else if (activeAds.Length == 0)
    {
            <p class="no-ads"><em>No ads available.</em></p>
    }
    else
    {
        foreach (var ad in activeAds)
        {
                    <div class="card">
                        <h5 class="card-title">@ad.Title</h5>
                        <img class="card-img" src="@ad.ImageUrl" alt="Item Image">
                        <div class="card-info">
                            <p>Price: @ad.Price.ToString("C")</p>
                            <p>Location: @ad.Location</p>
                            <p>Category: @ad.Category</p>
                            <p>Status: @ad.Status</p>
                            <p>Description: @ad.Description</p>
                            <p>Seller: @ad.SellerUserName</p>
                    @if (isLoggedIn)
                    {
                                    <button class="btn btn-primary" @onclick="() => PurchaseItem(ad)">Buy Now</button>
                    }
                        </div>
                    </div>
        }
    }
</div>


@code {
    private Ad[]? eaagenbrug;
    private string serverUrl = "https://localhost:7189";
    private string username = "Default User"; // Default username
    private bool isLoggedIn = false; // Login status
    private string ads = "No ads listed.";


    private Ad[]? activeAds = new Ad[0];



    private string busyDisplayStyle = "none";

    protected override async Task OnInitializedAsync()
    {
        await FetchUserDetails();
        await FetchAds();
    }

    private async Task FetchUserDetails()
    {
        try
        {
            isLoggedIn = await LocalStorage.GetItemAsync<bool>("isLoggedIn");

                if (isLoggedIn)
                {
                    username = await LocalStorage.GetItemAsync<string>("username") ?? "Default User";
                }
        }
            catch (Exception ex)
            {
                // Handle exception if needed
                Console.WriteLine($"Error fetching user details: {ex.Message}");
            }
    }

    private async Task FetchAds()
    {
        try
        {
            var allAds = await Http.GetFromJsonAsync<Ad[]>($"{serverUrl}/api/eaagenbrug/getall");
            activeAds = allAds?.Where(ad => ad.Status != "Sold").ToArray() ?? new Ad[0];
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load ads: {ex.Message}");
            activeAds = Array.Empty<Ad>();
        }
    }

    private async Task PurchaseItem(Ad ad)
    {

        ad.BuyerUserName = isLoggedIn ? username : "Guest"; // Set BuyerUserName based on login status

        var response = await Http.PostAsJsonAsync<Ad>($"{serverUrl}/api/eaagenbrug/purchase", ad);
        Console.WriteLine("Client: purchase " + ad.Title + " by " + ad.BuyerUserName);

        await FetchAds(); // Refresh the ads list after purchase
    }
}